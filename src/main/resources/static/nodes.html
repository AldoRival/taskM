<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Nodos - Sistema Distribuido</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .node-card {
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .node-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        .status-activo {
            background-color: #28a745;
            color: white;
        }
        .status-inactivo {
            background-color: #dc3545;
            color: white;
        }
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .heartbeat-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        .heartbeat-active {
            background-color: #28a745;
        }
        .heartbeat-inactive {
            background-color: #dc3545;
            animation: none;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        #loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .stats-container {
            margin-bottom: 20px;
        }
        .stat-card {
            text-align: center;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Sistema Distribuido de Tareas</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tasks.html">Tareas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/nodes.html">Nodos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor.html">Monitor</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container mt-4">
        <div class="node-header">
            <h2><i class="fas fa-network-wired"></i> Gestión de Nodos</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerNodeModal">
                <i class="fas fa-plus"></i> Registrar Nuevo Nodo
            </button>
        </div>

        <!-- Estadísticas de Nodos -->
        <div class="stats-container row">
            <div class="col-md-4 mb-3">
                <div class="stat-card bg-primary text-white">
                    <div class="stat-value" id="totalNodesCount">0</div>
                    <div class="stat-label">Total de Nodos</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card bg-success text-white">
                    <div class="stat-value" id="activeNodesCount">0</div>
                    <div class="stat-label">Nodos Activos</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card bg-danger text-white">
                    <div class="stat-value" id="inactiveNodesCount">0</div>
                    <div class="stat-label">Nodos Inactivos</div>
                </div>
            </div>
        </div>

        <!-- Filtros de búsqueda -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Filtros</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <select id="statusFilter" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activos</option>
                            <option value="inactivo">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="searchNode" class="form-control" placeholder="Buscar por ID...">
                    </div>
                    <div class="col-md-4">
                        <button id="applyFilters" class="btn btn-outline-primary w-100">Aplicar Filtros</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spinner de carga -->
        <div id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Cargando nodos...</p>
        </div>

        <!-- Listado de Nodos -->
        <div id="nodesList" class="row">
            <!-- Los nodos se cargarán dinámicamente aquí -->
        </div>

        <!-- Mensaje de no nodos -->
        <div id="noNodesMessage" class="alert alert-info text-center" style="display: none;">
            No hay nodos registrados en el sistema. ¡Registra un nuevo nodo!
        </div>
    </div>

    <!-- Modal para Registrar Nodo -->
    <div class="modal fade" id="registerNodeModal" tabindex="-1" aria-labelledby="registerNodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerNodeModalLabel">Registrar Nuevo Nodo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerNodeForm">
                        <div class="mb-3">
                            <label for="nodeId" class="form-label">ID del Nodo</label>
                            <input type="text" class="form-control" id="nodeId" placeholder="node-xxxx" required>
                            <div class="form-text">Ejemplo: node-1, node-worker-2, etc.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="submitNode">Registrar Nodo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalles del Nodo -->
    <div class="modal fade" id="nodeDetailsModal" tabindex="-1" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeDetailsModalLabel">Detalles del Nodo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="nodeDetailsContent">
                    <!-- Los detalles se cargarán aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center text-lg-start mt-5">
        <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.05);">
            © 2025 Sistema Distribuido de Gestión de Tareas
        </div>
    </footer>

    <!-- Bootstrap JS y Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript para la funcionalidad de la página -->
    <script>
        // Variables globales
        let nodes = [];
        const nodesList = document.getElementById('nodesList');
        const noNodesMessage = document.getElementById('noNodesMessage');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Actualizar contador de estadísticas
        function updateStats() {
            const totalNodes = nodes.length;
            const activeNodes = nodes.filter(node => node.status === 'activo').length;
            const inactiveNodes = nodes.filter(node => node.status === 'inactivo').length;
            
            document.getElementById('totalNodesCount').textContent = totalNodes;
            document.getElementById('activeNodesCount').textContent = activeNodes;
            document.getElementById('inactiveNodesCount').textContent = inactiveNodes;
        }

        // Función para cargar los nodos
        async function loadNodes() {
            try {
                showLoading(true);
                const response = await fetch('/nodes/status');
                const data = await response.json();
                nodes = data;
                renderNodes(nodes);
                updateStats();
                showLoading(false);
            } catch (error) {
                console.error('Error al cargar los nodos:', error);
                showLoading(false);
                alert('Error al cargar los nodos. Por favor, intente de nuevo.');
            }
        }

        // Mostrar/ocultar spinner de carga
        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        // Calcular tiempo desde el último heartbeat
        function getLastHeartbeatTime(lastHeartbeat) {
            if (!lastHeartbeat) return 'Nunca';
            
            const now = Date.now();
            const diff = now - lastHeartbeat;
            
            if (diff < 1000) return 'Ahora mismo';
            if (diff < 60000) return `Hace ${Math.floor(diff / 1000)} segundos`;
            if (diff < 3600000) return `Hace ${Math.floor(diff / 60000)} minutos`;
            return `Hace ${Math.floor(diff / 3600000)} horas`;
        }

        // Función para renderizar los nodos
        function renderNodes(nodesToRender) {
            nodesList.innerHTML = '';
            
            if (nodesToRender.length === 0) {
                noNodesMessage.style.display = 'block';
                return;
            }

            noNodesMessage.style.display = 'none';
            
            nodesToRender.forEach(node => {
                const isActive = node.status === 'activo';
                const heartbeatClass = isActive ? 'heartbeat-active' : 'heartbeat-inactive';
                const lastHeartbeatTime = getLastHeartbeatTime(node.lastHeartbeat);
                
                const nodeCard = document.createElement('div');
                nodeCard.className = 'col-md-6 col-lg-4';
                
                nodeCard.innerHTML = `
                    <div class="card node-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <span class="heartbeat-indicator ${heartbeatClass}"></span>
                                ${node.nodeId}
                            </h5>
                            <span class="badge status-badge status-${node.status}">${node.status}</span>
                        </div>
                        <div class="card-body">
                            <p class="text-muted"><small>Último heartbeat: ${lastHeartbeatTime}</small></p>
                            <p class="text-muted"><small>ID interno: ${node.id}</small></p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <button class="btn btn-sm btn-info" onclick="viewNodeDetails('${node.nodeId}')">
                                <i class="fas fa-eye"></i> Detalles
                            </button>
                            ${isActive ? 
                                `<button class="btn btn-sm btn-warning" onclick="deactivateNode('${node.nodeId}')">
                                    <i class="fas fa-power-off"></i> Desactivar
                                </button>` : 
                                `<button class="btn btn-sm btn-success" onclick="activateNode('${node.nodeId}')">
                                    <i class="fas fa-play"></i> Activar
                                </button>`
                            }
                        </div>
                    </div>
                `;
                
                nodesList.appendChild(nodeCard);
            });
        }

        // Ver detalles de un nodo
        async function viewNodeDetails(nodeId) {
            try {
                const node = nodes.find(n => n.nodeId === nodeId);
                if (!node) {
                    alert('Nodo no encontrado.');
                    return;
                }
                
                // Obtener tareas asignadas a este nodo (esto requeriría un endpoint adicional)
                let tasksHtml = '<p>Cargando tareas asignadas...</p>';
                try {
                    const tasksResponse = await fetch('/tasks');
                    const allTasks = await tasksResponse.json();
                    const nodeTasks = allTasks.filter(task => task.responsibleNode === nodeId);
                    
                    if (nodeTasks.length > 0) {
                        tasksHtml = `
                            <h6>Tareas Asignadas:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${nodeTasks.map(task => `
                                            <tr>
                                                <td>${task.id}</td>
                                                <td>${task.name}</td>
                                                <td><span class="badge bg-${task.status === 'completada' ? 'success' : task.status === 'procesando' ? 'primary' : task.status === 'fallida' ? 'danger' : 'warning'}">${task.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        tasksHtml = '<p>No hay tareas asignadas a este nodo.</p>';
                    }
                } catch (error) {
                    tasksHtml = '<p class="text-danger">Error al cargar las tareas asignadas.</p>';
                }
                
                const detailsContent = document.getElementById('nodeDetailsContent');
                detailsContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h4>${node.nodeId}</h4>
                            <span class="badge status-badge status-${node.status} mb-3">${node.status}</span>
                            
                            <h6>Información del Nodo:</h6>
                            <ul class="list-group mb-4">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ID interno
                                    <span>${node.id}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Estado
                                    <span>${node.status}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Último heartbeat
                                    <span>${new Date(node.lastHeartbeat).toLocaleString()}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Tiempo desde último heartbeat
                                    <span>${getLastHeartbeatTime(node.lastHeartbeat)}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            ${tasksHtml}
                        </div>
                    </div>
                `;
                
                const nodeDetailsModal = new bootstrap.Modal(document.getElementById('nodeDetailsModal'));
                nodeDetailsModal.show();
            } catch (error) {
                console.error('Error al cargar los detalles del nodo:', error);
                alert('Error al cargar los detalles del nodo.');
            }
        }

        // Activar un nodo
        async function activateNode(nodeId) {
            try {
                showLoading(true);
                const response = await fetch(`/nodes/register/${nodeId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Error al activar el nodo');
                
                // Recargar los nodos
                await loadNodes();
                showLoading(false);
                alert(`Nodo ${nodeId} activado correctamente.`);
            } catch (error) {
                console.error('Error al activar el nodo:', error);
                showLoading(false);
                alert('Error al activar el nodo.');
            }
        }

        // Desactivar un nodo
        async function deactivateNode(nodeId) {
            if (confirm(`¿Está seguro de que desea desactivar el nodo ${nodeId}?`)) {
                try {
                    showLoading(true);
                    const response = await fetch(`/nodes/${nodeId}/deactivate`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('Error al desactivar el nodo');
                    
                    // Recargar los nodos
                    await loadNodes();
                    showLoading(false);
                    alert(`Nodo ${nodeId} desactivado correctamente.`);
                } catch (error) {
                    console.error('Error al desactivar el nodo:', error);
                    showLoading(false);
                    alert('Error al desactivar el nodo.');
                }
            }
        }

        // Aplicar filtros
        document.getElementById('applyFilters').addEventListener('click', () => {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchNode').value.toLowerCase();
            
            let filteredNodes = nodes;
            
            if (statusFilter) {
                filteredNodes = filteredNodes.filter(node => node.status === statusFilter);
            }
            
            if (searchQuery) {
                filteredNodes = filteredNodes.filter(node => 
                    node.nodeId.toLowerCase().includes(searchQuery)
                );
            }
            
            renderNodes(filteredNodes);
        });

        // Registrar un nuevo nodo
        document.getElementById('submitNode').addEventListener('click', async () => {
            const nodeId = document.getElementById('nodeId').value;
            
            if (!nodeId) {
                alert('Por favor, ingrese un ID para el nodo.');
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch(`/nodes/register/${nodeId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Error al registrar el nodo');
                
                // Cerrar el modal
                const registerNodeModal = bootstrap.Modal.getInstance(document.getElementById('registerNodeModal'));
                registerNodeModal.hide();
                
                // Limpiar el formulario
                document.getElementById('registerNodeForm').reset();
                
                // Recargar la lista de nodos
                await loadNodes();
                showLoading(false);
                alert(`Nodo ${nodeId} registrado correctamente.`);
            } catch (error) {
                console.error('Error al registrar el nodo:', error);
                showLoading(false);
                alert('Error al registrar el nodo.');
            }
        });

        // Programar actualización automática de la lista de nodos cada 10 segundos
        setInterval(loadNodes, 10000);

        // Cargar los nodos al cargar la página
        document.addEventListener('DOMContentLoaded', loadNodes);
    </script>
</body>
</html>